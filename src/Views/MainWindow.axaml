<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:X4PlayerShipTradeAnalyzer.ViewModels"
    xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Avalonia;assembly=LiveChartsCore.SkiaSharpView.Avalonia"
    xmlns:conv="clr-namespace:X4PlayerShipTradeAnalyzer.Converters"
    xmlns:mdv="clr-namespace:MarkdownViewer.Core.Controls;assembly=MarkdownViewer.Core"
    x:Class="X4PlayerShipTradeAnalyzer.Views.MainWindow"
  Width="1200" Height="800"
  Title="X4 Player Ship Trade Analyzer">
  <Window.Resources>
    <conv:NullToUnsetBrushConverter x:Key="NullToUnsetBrush" />
    <conv:ZeroToRedBrushConverter x:Key="ZeroToRed" />
    <conv:ZeroToRedIfEnabledConverter x:Key="ZeroToRedIfEnabled" />
    <conv:EnumEqualsConverter x:Key="EnumEquals" />
    <conv:BoolToChartPositionConverter x:Key="BoolToChartPos" />
    <conv:LoadPercentToBrushConverter x:Key="LoadPercentToBrushConverter"/>
  </Window.Resources>
  <Window.Styles>
    <Style Selector="TextBlock.RightAligned">
      <Setter Property="TextAlignment" Value="Right"/>
      <Setter Property="HorizontalAlignment" Value="Right"/>
    </Style>
    <Style Selector="TextBlock.RightAlignedPadded" >
      <Setter Property="TextAlignment" Value="Right"/>
      <Setter Property="HorizontalAlignment" Value="Right"/>
      <Setter Property="Padding" Value="8"/>
    </Style>
  </Window.Styles>

  <Design.DataContext>
    <vm:MainViewModel baseDir="."/>
  </Design.DataContext>

  <TabControl Grid.Row="1" x:Name="MainTabs" SelectionChanged="MainTabs_SelectionChanged">
    <!-- Parent: By Transactions -->
    <TabItem Header="By Transactions" x:Name="ByTransactionsTab">
      <TabControl x:Name="ByTransactionsTabs">
        <TabItem Header="Ships Transactions" x:Name="TransactionsTab">
          <Grid DataContext="{Binding TransactionsData}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="36" />
                <RowDefinition />
                <RowDefinition Height="34" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center" />
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}"  VerticalAlignment="Center"  Margin="8,0,16,0" Width="70"/>
                <TextBlock Text="Sort:" VerticalAlignment="Center"/>
                <RadioButton Content="Name" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Name}"/>
                <RadioButton Content="Profit" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Profit}"/>
              </StackPanel>
            </Border>

            <Border Grid.Row="1" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <ListBox ItemsSource="{Binding ShipList}"
                      SelectedItem="{Binding SelectedShip, Mode=TwoWay}"
                      Margin="8" Width="340">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="*,8,Auto">
                      <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}"/>
                      <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="SemiBold" Classes="RightAligned"  Margin="0"/>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Border>
            <Border Grid.Row="2" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="4" Margin="0">
                <TextBlock Text="Transport:" VerticalAlignment="Center"/>
                <RadioButton Content="All" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=All}"/>
                <RadioButton Content="Container" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Container}"/>
                <RadioButton Content="Solid" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Solid}"/>
                <RadioButton Content="Liquid" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Liquid}"/>
              </StackPanel>
            </Border>

                      <!-- Row 0, Column 1: summary values -->
            <Border Grid.Row="0" Grid.Column="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center" Spacing="24">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Ship:"/>
                  <TextBlock Text="{Binding SelectedShip.ShipName}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Total Profit:"/>
                  <TextBlock Text="{Binding TotalProfit}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Items Traded:"/>
                  <TextBlock Text="{Binding ItemsTraded}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Time in Service:"/>
                  <TextBlock Text="{Binding TimeInService}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Elapsed Time (Buyâ†’Sell):"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Min:"/>
                    <TextBlock Text="{Binding TimeMin}" FontWeight="Bold"/>
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Avg:"/>
                    <TextBlock Text="{Binding TimeAvg}" FontWeight="Bold"/>
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Max:"/>
                    <TextBlock Text="{Binding TimeMax}" FontWeight="Bold"/>
                  </StackPanel>
                </StackPanel>
              </StackPanel>
            </Border>

            <Border Grid.Row="1" Grid.RowSpan="2" Grid.Column="1" BorderBrush="Gray" BorderThickness="0" Padding="4">

              <DataGrid ItemsSource="{Binding FilteredTransactions}"
                        AutoGenerateColumns="False"
                        IsReadOnly="True"
                        Margin="8">
                <DataGrid.Columns>
                  <DataGridTemplateColumn Header="Time" SortMemberPath="Time" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Time}" Classes="RightAlignedPadded"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Sector" SortMemberPath="Sector" Width="180">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Sector}" ToolTip.Tip="{Binding Sector}" Margin="8"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Station" SortMemberPath="Station" Width="180">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Station}" ToolTip.Tip="{Binding Station}" Margin="8"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTextColumn Header="Operation" Binding="{Binding Operation}" Width="100"/>
                  <DataGridTemplateColumn Header="Product" SortMemberPath="Product" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Product}" ToolTip.Tip="{Binding Product}" Margin="8"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Price" SortMemberPath="Price" Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Price, StringFormat=N2}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Quantity" SortMemberPath="Quantity" Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Quantity, StringFormat=N0}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Load, %" SortMemberPath="LoadPercent" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding LoadPercent, StringFormat=N2}"
                                    Foreground="{Binding LoadPercent, Converter={StaticResource LoadPercentToBrushConverter}}"
                                    Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Total" SortMemberPath="Total" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Total, StringFormat=N2}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Estimated Profit" SortMemberPath="EstimatedProfit" Width="140">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding EstimatedProfit, StringFormat=N2}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Dist." SortMemberPath="Distance" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Distance, StringFormat=N0}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                </DataGrid.Columns>
              </DataGrid>

            </Border>
          </Grid>
        </TabItem>

        <TabItem Header="Ships Graphs" x:Name="TransactionsGraphsTab">
          <Grid DataContext="{Binding TransactionsGraphs}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="36" />
                <RowDefinition />
                <RowDefinition Height="34" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center" />
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}"  VerticalAlignment="Center"  Margin="8,0,16,0" Width="70"/>
                <TextBlock Text="Sort:" VerticalAlignment="Center"/>
                <RadioButton Content="Name" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Name}"/>
                <RadioButton Content="Profit" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Profit}"/>
              </StackPanel>
            </Border>

            <Border Grid.Row="1" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <ListBox ItemsSource="{Binding ShipList}"
                      Margin="8" Width="340"
                      DoubleTapped="ShipGraphsList_DoubleTapped">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="*,8,Auto">
                      <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}"
                                  FontWeight="{Binding FontWeight}" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="SemiBold" Classes="RightAligned"  Margin="0"/>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Border>
            <Border Grid.Row="2" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="4" Margin="0">
                <TextBlock Text="Transport:" VerticalAlignment="Center"/>
                <RadioButton Content="All" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=All}"/>
                <RadioButton Content="Container" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Container}"/>
                <RadioButton Content="Solid" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Solid}"/>
                <RadioButton Content="Liquid" GroupName="TxTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Liquid}"/>
              </StackPanel>
            </Border>
            <Border Grid.Row="0" Grid.RowSpan="3" Grid.Column="1" BorderBrush="Gray" BorderThickness="0" Padding="8">
              <lvc:CartesianChart Series="{Binding Series}"
                                  XAxes="{Binding XAxes}"
                                  YAxes="{Binding YAxes}"/>
            </Border>
          </Grid>
        </TabItem>
        <TabItem Header="Ships by Wares Stats" x:Name="TransactionsStatsShipsWaresTab">
          <Grid DataContext="{Binding TransactionsStatsShipsWares}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <!-- Filters row -->
            <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <Grid Grid.ColumnDefinitions="*,Auto" >
                <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="4" Margin="0">
                  <TextBlock Text="Transport:" VerticalAlignment="Center"/>
                  <RadioButton Content="All" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=All}"/>
                  <RadioButton Content="Container" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Container}"/>
                  <RadioButton Content="Solid" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Solid}"/>
                  <RadioButton Content="Liquid" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Liquid}"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                  <TextBlock Text="Class:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                  <TextBlock Text="Top N Ships:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                  <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
                </StackPanel>
              </Grid>
            </Border>
            <!-- Chart + custom legend -->
            <Grid Grid.Row="1" ColumnDefinitions="340, *" RowDefinitions="Auto,*,34">
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36, Auto">
                  <TextBlock Grid.Column="0" Grid.Row="0"  Grid.ColumnSpan="5" Text="Selected Ship:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedShipName}" ToolTip.Tip="{Binding PressedShipName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedShipTotal}" FontWeight="Bold" Classes="RightAligned"/>
                </Grid>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
                <ListBox ItemsSource="{Binding ShipWaresList}"
                        Background="Transparent"
                        Margin="0" Width="340">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid ColumnDefinitions="*,8,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding Name}" ToolTip.Tip="{Binding Name}" FontWeight="SemiBold"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        <TextBlock Grid.Column="2" Text="{Binding Money, StringFormat=N2}" FontWeight="Bold" Classes="RightAligned"  Margin="0"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </Border>
              <Border Grid.Column="0" Grid.Row="2" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
              <Border Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Grid.Column="0"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        x:Name="TransactionsShipsByWaresChart"
                                        TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}"
                                        LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
        <TabItem Header="Ships Load Distribution" x:Name="TransactionsStatsShipsLoadTab">
          <Grid DataContext="{Binding TransactionsStatsShipsLoad}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" >
              <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="4" Margin="0">
                <TextBlock Text="Transport:" VerticalAlignment="Center"/>
                <RadioButton Content="All" GroupName="TxLoadTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=All}"/>
                <RadioButton Content="Container" GroupName="TxLoadTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Container}"/>
                <RadioButton Content="Solid" GroupName="TxLoadTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Solid}"/>
                <RadioButton Content="Liquid" GroupName="TxLoadTransport"
                            IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Liquid}"/>
              </StackPanel>
              <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                <TextBlock Text="Top N Ships:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
              </StackPanel>
            </Grid>
            <Grid Grid.Row="1" ColumnDefinitions="340,*" RowDefinitions="*,34">
              <!-- Sidebar -->
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36,Auto,*">
                  <TextBlock Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="5" Text="Selected Ship:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedShipName}" ToolTip.Tip="{Binding PressedShipName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedShipTotal}" FontWeight="Bold" Classes="RightAligned"/>
                  <ListBox Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="5" ItemsSource="{Binding ShipBucketsList}" BorderThickness="0">
                    <ListBox.Styles>
                      <Style Selector="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                      </Style>
                    </ListBox.Styles>
                    <ListBox.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="4,168,8,140,4">
                          <TextBlock Grid.Column="1" Text="{Binding Name}" FontWeight="{Binding FontWeight}" Margin="0" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                          <TextBlock Grid.Column="3" Text="{Binding Percent, StringFormat=N2}%" FontWeight="Bold" Classes="RightAligned" Margin="0" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        </Grid>
                      </DataTemplate>
                    </ListBox.ItemTemplate>
                  </ListBox>
                </Grid>
              </Border>
              <!-- Chart -->
              <Border Grid.Column="1" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Series="{Binding Series}" XAxes="{Binding XAxes}" YAxes="{Binding YAxes}" x:Name="TransactionsShipsLoadChart" TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}" LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
        <TabItem Header="Wares by Ships Stats" x:Name="TransactionsStatsWaresShipsTab">
          <Grid DataContext="{Binding TransactionsStatsWaresShips}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <!-- Filters row -->
            <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <Grid Grid.ColumnDefinitions="*,Auto" >
                <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="4" Margin="0">
                  <TextBlock Text="Transport:" VerticalAlignment="Center"/>
                  <RadioButton Content="All" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=All}"/>
                  <RadioButton Content="Container" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Container}"/>
                  <RadioButton Content="Solid" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Solid}"/>
                  <RadioButton Content="Liquid" GroupName="TxTransport"
                              IsChecked="{Binding Transport, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Liquid}"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                  <TextBlock Text="Class:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                  <TextBlock Text="Top N Wares:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                  <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
                </StackPanel>
              </Grid>
            </Border>
            <!-- Chart + custom legend -->
            <Grid Grid.Row="1" ColumnDefinitions="340, *" RowDefinitions="Auto,*,34">
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36, Auto">
                  <TextBlock Grid.Column="0" Grid.Row="0"  Grid.ColumnSpan="5" Text="Selected Ware:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedWareName}" ToolTip.Tip="{Binding PressedWareName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedWareTotal}" FontWeight="Bold" Classes="RightAligned"/>
                </Grid>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
                <ListBox ItemsSource="{Binding WareShipsList}"
                        Background="Transparent"
                        Margin="0" Width="340">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid ColumnDefinitions="*,8,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}" FontWeight="SemiBold"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="Bold" Classes="RightAligned"  Margin="0"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </Border>
              <Border Grid.Column="0" Grid.Row="2" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
              <Border Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Grid.Column="0"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        x:Name="TransactionsWaresByShipsChart"
                                        TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}"
                                        LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
      </TabControl>
    </TabItem>

    <!-- Parent: By Trades -->
    <TabItem Header="By Trades" x:Name="ByTradesTab">
      <TabControl x:Name="ByTradesTabs">
        <TabItem Header="Ships Trades" x:Name="TradesTab">
          <Grid DataContext="{Binding TradesData}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="36" />
                <RowDefinition />
                <RowDefinition Height="34" />
            </Grid.RowDefinitions>

            <!-- Filters / summary row -->
            <Border Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Spacing="24">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Ship:"/>
                  <TextBlock Text="{Binding SelectedShip.ShipName}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Total Profit:"/>
                  <TextBlock Text="{Binding TotalProfit}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Items Traded:"/>
                  <TextBlock Text="{Binding ItemsTraded}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Time in Service:"/>
                  <TextBlock Text="{Binding TimeInService}" FontWeight="Bold"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Trade Time:"/>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Min:"/>
                    <TextBlock Text="{Binding TimeMin}" FontWeight="Bold"/>
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Avg:"/>
                    <TextBlock Text="{Binding TimeAvg}" FontWeight="Bold"/>
                  </StackPanel>
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="Max:"/>
                    <TextBlock Text="{Binding TimeMax}" FontWeight="Bold"/>
                  </StackPanel>
                </StackPanel>
              </StackPanel>
            </Border>

            <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center" />
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}"  VerticalAlignment="Center"  Margin="8,0,16,0" Width="70"/>
                <TextBlock Text="Sort:" VerticalAlignment="Center"/>
                <RadioButton Content="Name" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Name}"/>
                <RadioButton Content="Profit" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Profit}"/>
              </StackPanel>
            </Border>

            <!-- Left: ships list -->
            <Border Grid.Row="1" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <ListBox ItemsSource="{Binding ShipList}"
                      SelectedItem="{Binding SelectedShip, Mode=TwoWay}"
                      Margin="8" Width="340">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="*,8,Auto">
                      <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}"/>
                      <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="SemiBold" Classes="RightAligned"  Margin="0"/>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Border>

            <Border Grid.Row="2" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                <CheckBox Content="With Internal Trades" IsChecked="{Binding WithInternalTrades, Mode=TwoWay}"/>
              </StackPanel>
            </Border>

    <!-- Middle: full trades grid -->
            <Border Grid.Row="1" Grid.RowSpan="2" Grid.Column="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <DataGrid ItemsSource="{Binding FilteredFullTrades}"
                        SelectedItem="{Binding SelectedFullTrade, Mode=TwoWay}"
                        AutoGenerateColumns="False"
                        IsReadOnly="True"
                        Margin="8">
                <DataGrid.Columns>
                  <DataGridTemplateColumn Header="Time" SortMemberPath="Time" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Time}" Classes="RightAlignedPadded"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTextColumn Header="Product" Binding="{Binding Product}" Width="200"/>
                  <DataGridTemplateColumn Header="Quantity" SortMemberPath="BoughtQuantity" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding BoughtQuantity, StringFormat=N0}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Load, %" SortMemberPath="LoadPercent" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding LoadPercent, StringFormat=N2}"
                                    Foreground="{Binding LoadPercent, Converter={StaticResource LoadPercentToBrushConverter}}"
                                    Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Profit" SortMemberPath="Profit" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Profit, StringFormat=N2}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Spent Time" SortMemberPath="SpentTime" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding SpentTime}" Classes="RightAlignedPadded"/>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Dist." SortMemberPath="Distance" Width="90">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Distance, StringFormat=N0}" Classes="RightAlignedPadded" />
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                </DataGrid.Columns>
              </DataGrid>
            </Border>

    <!-- Right: combined steps grid -->
            <Border Grid.Row="1" Grid.RowSpan="2" Grid.Column="2" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <DataGrid ItemsSource="{Binding TradeSteps}"
                        AutoGenerateColumns="False"
                        IsReadOnly="True"
                        Margin="8">
                <DataGrid.Columns>
                <DataGridTemplateColumn Header="Time" SortMemberPath="Time" Width="90">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Time}" Classes="RightAlignedPadded"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Op." Binding="{Binding Operation}" Width="60"/>
                <DataGridTemplateColumn Header="Qnt."  SortMemberPath="Volume" Width="80">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Volume, StringFormat=N0}" Classes="RightAlignedPadded"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="Price" SortMemberPath="Price" Width="80">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Price, StringFormat=N2}" Classes="RightAlignedPadded" />
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="Sector" SortMemberPath="Sector" Width="140">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Sector}" ToolTip.Tip="{Binding Sector}" Margin="8"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="Station" SortMemberPath="Station" Width="Auto">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Station}" ToolTip.Tip="{Binding Station}" Margin="8"/>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                </DataGrid.Columns>
              </DataGrid>
            </Border>
          </Grid>
        </TabItem>
        <TabItem Header="Ships Graphs" x:Name="TradesGraphsTab">
          <Grid DataContext="{Binding TradesGraphs}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="36" />
                <RowDefinition />
                <RowDefinition Height="34" />
            </Grid.RowDefinitions>
            <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center" />
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}"  VerticalAlignment="Center"  Margin="8,0,16,0" Width="70"/>
                <TextBlock Text="Sort:" VerticalAlignment="Center"/>
                <RadioButton Content="Name" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Name}"/>
                <RadioButton Content="Profit" GroupName="ShipsSort" Margin="8,0,0,0"
                              IsChecked="{Binding ShipsSortOrder, Mode=TwoWay, Converter={StaticResource EnumEquals}, ConverterParameter=Profit}"/>
              </StackPanel>
            </Border>
            <Border Grid.Row="1" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
              <ListBox ItemsSource="{Binding ShipList}"
                  Margin="8" Width="340"
                  DoubleTapped="ShipGraphsList_DoubleTapped">
                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="*,8,Auto">
                      <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}"
                                  FontWeight="{Binding FontWeight}" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="SemiBold" Classes="RightAligned"  Margin="0"/>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Border>
            <!-- Filters row -->
            <Border Grid.Row="2" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <StackPanel Orientation="Horizontal" Spacing="12">
                    <CheckBox Content="With Internal Trades" IsChecked="{Binding WithInternalTrades, Mode=TwoWay}"/>
                  </StackPanel>
                </StackPanel>
            </Border>
            <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1" BorderBrush="Gray" BorderThickness="0" Padding="8">
              <lvc:CartesianChart Series="{Binding Series}"
                                  XAxes="{Binding XAxes}"
                                  YAxes="{Binding YAxes}"/>
            </Border>
          </Grid>
        </TabItem>
        <TabItem Header="Ships by Wares Stats" x:Name="TradesStatsShipsWaresTab">
          <Grid DataContext="{Binding TradesStatsShipsWares}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <!-- Filters row -->
            <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <Grid Grid.ColumnDefinitions="*,Auto" >
                <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="24">
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <CheckBox Content="With Internal Trades" IsChecked="{Binding WithInternalTrades, Mode=TwoWay}"/>
                      </StackPanel>
                    </StackPanel>
                </Border>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                  <TextBlock Text="Class:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                  <TextBlock Text="Top N Ships:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                  <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
                </StackPanel>
              </Grid>
            </Border>
            <!-- Chart + custom legend -->
            <Grid Grid.Row="1" ColumnDefinitions="340, *" RowDefinitions="Auto,*,34">
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36, Auto">
                  <TextBlock Grid.Column="0" Grid.Row="0"  Grid.ColumnSpan="5" Text="Selected Ship:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedShipName}" ToolTip.Tip="{Binding PressedShipName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedShipTotal}" FontWeight="Bold" Classes="RightAligned"/>
                </Grid>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
                <ListBox ItemsSource="{Binding ShipWaresList}"
                        Background="Transparent"
                        Margin="0" Width="340">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid ColumnDefinitions="*,8,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding Name}" ToolTip.Tip="{Binding Name}" FontWeight="SemiBold"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        <TextBlock Grid.Column="2" Text="{Binding Money, StringFormat=N2}" FontWeight="Bold" Classes="RightAligned"  Margin="0"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </Border>
              <Border Grid.Column="0" Grid.Row="2" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
              <Border Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Grid.Column="0"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        x:Name="TradesShipsByWaresChart"
                                        TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}"
                                        LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
        <TabItem Header="Ships Load Distribution" x:Name="TradesStatsShipsLoadTab">
          <Grid DataContext="{Binding TradesStatsShipsLoad}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto" >
              <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24" Margin="0">
                <CheckBox Content="With Internal Trades" IsChecked="{Binding WithInternalTrades, Mode=TwoWay}"/>
              </StackPanel>
              <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                <TextBlock Text="Class:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                <TextBlock Text="Top N Ships:" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
              </StackPanel>
            </Grid>
            <Grid Grid.Row="1" ColumnDefinitions="340,*" RowDefinitions="*,34">
              <!-- Sidebar -->
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36,Auto,*">
                  <TextBlock Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="5" Text="Selected Ship:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedShipName}" ToolTip.Tip="{Binding PressedShipName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedShipTotal}" FontWeight="Bold" Classes="RightAligned"/>
                  <ListBox Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="5" ItemsSource="{Binding ShipBucketsList}" BorderThickness="0">
                    <ListBox.Styles>
                      <Style Selector="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                      </Style>
                    </ListBox.Styles>
                    <ListBox.ItemTemplate>
                      <DataTemplate>
                        <Grid ColumnDefinitions="4,168,8,140,4">
                          <TextBlock Grid.Column="1" Text="{Binding Name}" FontWeight="{Binding FontWeight}" Margin="0" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                          <TextBlock Grid.Column="3" Text="{Binding Percent, StringFormat=N2}%" FontWeight="Bold" Classes="RightAligned" Margin="0" Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        </Grid>
                      </DataTemplate>
                    </ListBox.ItemTemplate>
                  </ListBox>
                </Grid>
              </Border>
              <!-- Chart -->
              <Border Grid.Column="1" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Series="{Binding Series}" XAxes="{Binding XAxes}" YAxes="{Binding YAxes}" x:Name="TradesShipsLoadChart" TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}" LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
        <TabItem Header="Wares by Ships Stats" x:Name="TradesStatsWaresShipsTab">
          <Grid DataContext="{Binding TradesStatsWaresShips}">
            <Grid.RowDefinitions>
              <RowDefinition Height="34" />
              <RowDefinition />
            </Grid.RowDefinitions>
            <!-- Filters row -->
            <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
              <Grid Grid.ColumnDefinitions="*,Auto" >
                <Border Grid.Row="0" Grid.Column="0" BorderBrush="Gray" BorderThickness="0" Padding="4">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="24">
                      <StackPanel Orientation="Horizontal" Spacing="12">
                        <CheckBox Content="With Internal Trades" IsChecked="{Binding WithInternalTrades, Mode=TwoWay}"/>
                      </StackPanel>
                    </StackPanel>
                </Border>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8" Margin="0">
                  <TextBlock Text="Class:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding ShipClassOptions}" SelectedItem="{Binding SelectedShipClass}" Width="70"/>
                  <TextBlock Text="Top N Wares:" VerticalAlignment="Center"/>
                  <ComboBox ItemsSource="{Binding TopNOptions}" SelectedItem="{Binding TopN}" />
                  <CheckBox Content="Reverse Order" IsChecked="{Binding ReverseSort}" VerticalAlignment="Center"/>
                </StackPanel>
              </Grid>
            </Border>
            <!-- Chart + custom legend -->
            <Grid Grid.Row="1" ColumnDefinitions="340, *" RowDefinitions="Auto,*,34">
              <Border Grid.Column="0" Grid.Row="0" BorderBrush="Gray" BorderThickness="0" Width="340" Padding="0">
                <Grid ColumnDefinitions="12,168,8,140,12" RowDefinitions="36, Auto">
                  <TextBlock Grid.Column="0" Grid.Row="0"  Grid.ColumnSpan="5" Text="Selected Ware:" FontWeight="Bold" HorizontalAlignment="Center"/>
                  <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding PressedWareName}" ToolTip.Tip="{Binding PressedWareName}" FontWeight="SemiBold"/>
                  <TextBlock Grid.Column="3" Grid.Row="1" Text="{Binding PressedWareTotal}" FontWeight="Bold" Classes="RightAligned"/>
                </Grid>
              </Border>
              <Border Grid.Column="0" Grid.Row="1" BorderBrush="Gray" BorderThickness="0" Padding="4">
                <ListBox ItemsSource="{Binding WareShipsList}"
                        Background="Transparent"
                        Margin="0" Width="340">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Grid ColumnDefinitions="*,8,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding ShipName}" ToolTip.Tip="{Binding ShipName}" FontWeight="SemiBold"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                        <TextBlock Grid.Column="2" Text="{Binding EstimatedProfit, StringFormat=N2}" FontWeight="Bold" Classes="RightAligned"  Margin="0"
                                    Foreground="{Binding GraphBrush, Converter={StaticResource NullToUnsetBrush}}"/>
                      </Grid>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                </ListBox>
              </Border>
              <Border Grid.Column="0" Grid.Row="2" BorderBrush="Gray" BorderThickness="0" Padding="0">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24">
                  <TextBlock Text="Display Tooltip:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                  <CheckBox IsChecked="{Binding ShowToolTip}" VerticalAlignment="Center"/>
                </StackPanel>
              </Border>
              <Border Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0" Padding="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                  <Border MinWidth="{Binding ChartMinWidth}">
                    <lvc:CartesianChart Grid.Column="0"
                                        Series="{Binding Series}"
                                        XAxes="{Binding XAxes}"
                                        YAxes="{Binding YAxes}"
                                        x:Name="TradesWaresByShipsChart"
                                        TooltipPosition="{Binding ShowToolTip, Converter={StaticResource BoolToChartPos}}"
                                        LegendPosition="Hidden"/>
                  </Border>
                </ScrollViewer>
              </Border>
            </Grid>
          </Grid>
        </TabItem>
      </TabControl>
    </TabItem>
    <TabItem Header="Configuration" x:Name="ConfigurationTab">
      <Grid DataContext="{Binding Configuration}" Margin="12">
        <Grid.RowDefinitions>
          <!-- Game folder row -->
          <RowDefinition Height="Auto"/>
          <!-- Small gap below game folder -->
          <RowDefinition Height="8"/>
          <!-- Game-data statistics row -->
          <RowDefinition Height="Auto"/>
          <!-- Big separation between blocks -->
          <RowDefinition Height="32"/>
          <!-- Game save path row -->
          <RowDefinition Height="Auto"/>
          <!-- Small gap below save path -->
          <RowDefinition Height="8"/>
          <!-- Save-data statistics row -->
          <RowDefinition Height="Auto"/>
          <!-- Gap before theme selector -->
          <RowDefinition Height="8"/>
          <!-- Theme selector row -->
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="160"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="12"/>
          <!-- New column for Load Only Game Language checkbox -->
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="12"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="12"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Wares + Language statistics row (each stat on its own line) -->
        <Border Grid.Row="2" Grid.ColumnSpan="7" BorderBrush="Gray" BorderThickness="0 0 0 1" Padding="0 0 0 8">
          <StackPanel Orientation="Vertical" Spacing="6">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Languages:" />
              <TextBlock Text="{Binding LanguagesCount}" FontWeight="Bold" Foreground="{Binding LanguagesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Texts ( " Foreground="{Binding CurrentLanguageTextCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="Language Id: "/>
              <TextBlock Text="{Binding CurrentLanguageId}" FontWeight="Bold" Foreground="{Binding CurrentLanguageId, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="):" Foreground="{Binding CurrentLanguageTextCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding CurrentLanguageTextCount}" FontWeight="Bold" Foreground="{Binding CurrentLanguageTextCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Wares:" Foreground="{Binding WaresCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding WaresCount}" FontWeight="Bold" Foreground="{Binding WaresCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Factions:" Foreground="{Binding FactionsCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding FactionsCount}" FontWeight="Bold" Foreground="{Binding FactionsCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Cluster/Sector names:" Foreground="{Binding ClusterSectorNamesCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding ClusterSectorNamesCount}" FontWeight="Bold" Foreground="{Binding ClusterSectorNamesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Storages:" Foreground="{Binding StoragesCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding StoragesCount}" FontWeight="Bold" Foreground="{Binding StoragesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Ship storages:" Foreground="{Binding ShipStoragesCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding ShipStoragesCount}" FontWeight="Bold" Foreground="{Binding ShipStoragesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Game Folder (X4.exe) -->
        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="Game Folder"/>
        <TextBlock Grid.Row="0" Grid.Column="1" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" Text="{Binding GameFolderExePath}"/>
        <Button Grid.Row="0" Grid.Column="2" Content="Set" Click="SetGameFolder_Click"/>
  <CheckBox Grid.Row="0" Grid.Column="4" Content="Load Only Game Language" IsChecked="{Binding LoadOnlyGameLanguage, Mode=TwoWay}" VerticalAlignment="Center"/>
  <Button Grid.Row="0" Grid.Column="6" Content="Load Game Data" IsEnabled="{Binding CanReloadGameData}" Click="ReloadGameData_Click"/>

        <!-- Theme selector -->
        <TextBlock Grid.Row="8" Grid.Column="0" VerticalAlignment="Center" Text="Theme"/>
        <ComboBox Grid.Row="8" Grid.Column="1" Width="200"
            SelectedItem="{Binding AppTheme, Mode=TwoWay}">
          <x:String>System</x:String>
          <x:String>Light</x:String>
          <x:String>Dark</x:String>
        </ComboBox>

  <!-- Save-data statistics table (each stat on its own line) -->
        <Border Grid.Row="6" Grid.ColumnSpan="7" BorderBrush="Gray" BorderThickness="0 0 0 1" Padding="8 0 0 8">
          <StackPanel Orientation="Vertical" Spacing="6">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Player ships:" Foreground="{Binding PlayerShipsCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding PlayerShipsCount}" FontWeight="Bold" Foreground="{Binding PlayerShipsCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Stations:" Foreground="{Binding StationsCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding StationsCount}" FontWeight="Bold" Foreground="{Binding StationsCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Gates Connections:" Foreground="{Binding GatesCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding GatesCount}" FontWeight="Bold" Foreground="{Binding GatesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Removed objects:">
                <TextBlock.Foreground>
                  <MultiBinding Converter="{StaticResource ZeroToRedIfEnabled}">
                    <Binding Path="RemovedObjectCount"/>
                    <Binding Path="LoadRemovedObjects"/>
                  </MultiBinding>
                </TextBlock.Foreground>
              </TextBlock>
              <TextBlock Text="{Binding RemovedObjectCount}" FontWeight="Bold">
                <TextBlock.Foreground>
                  <MultiBinding Converter="{StaticResource ZeroToRedIfEnabled}">
                    <Binding Path="RemovedObjectCount"/>
                    <Binding Path="LoadRemovedObjects"/>
                  </MultiBinding>
                </TextBlock.Foreground>
              </TextBlock>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6">
              <TextBlock Text="Trades:" Foreground="{Binding TradesCount, Converter={StaticResource ZeroToRed}}"/>
              <TextBlock Text="{Binding TradesCount}" FontWeight="Bold" Foreground="{Binding TradesCount, Converter={StaticResource ZeroToRed}}"/>
            </StackPanel>
          </StackPanel>
        </Border>

              <!-- Game Save Path -->
  <TextBlock Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" Text="Game Save Path"/>
  <TextBlock Grid.Row="4" Grid.Column="1" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" Text="{Binding GameSavePath}"/>
  <Button Grid.Row="4" Grid.Column="2" Content="Set" Click="SetSaveFolder_Click"/>
  <!-- Option checkbox before Load Save button -->
  <CheckBox Grid.Row="4" Grid.Column="4" Content="Load removed objects" IsChecked="{Binding LoadRemovedObjects, Mode=TwoWay}" VerticalAlignment="Center"/>
  <Button Grid.Row="4" Grid.Column="6" Content="Load Save Data" IsEnabled="{Binding CanReloadSaveData}" Click="ReloadSaveData_Click"/>
      </Grid>
    </TabItem>

    <TabItem Header="Readme" x:Name="ReadmeTab">
      <Grid>
        <ScrollViewer Margin="8" VerticalScrollBarVisibility="Auto" x:Name="ReadmeScrollViewer"/>
      </Grid>
    </TabItem>
  </TabControl>
</Window>
